# Webplyzer 要件定義書

## 1. プロダクト概要
Webplyzer は Next.js 15（App Router + TypeScript）で構築された WebP 変換ツールです。ユーザーは JPG/JPEG/PNG ファイルを最大 25 件まとめてアップロードし、ドラッグ&ドロップで順序を調整したうえで WebP 形式へ変換できます。サーバーサイドで `sharp` を用いた高速変換を行い、単一ファイルは直接、複数ファイルは ZIP でダウンロードできます。

## 2. 提供価値
- **運用効率化**: 大量画像の WebP 化・連番リネーム・一括ダウンロードを 1 画面で完結。
- **品質と安定性**: Node ランタイムで `sharp` を利用し、アルファチャンネル保持・品質 90 の安定した変換を提供。
- **グローバルチーム対応**: 日本語 / 英語 / 韓国語の UI 切り替えを標準サポート。

## 3. 対象ユーザー
- Web・ブログ運用担当者
- EC サイトの画像管理者
- デザイン／制作会社のフロントエンドチーム

## 4. システム構成
- **フレームワーク**: Next.js 15 App Router（`app/` ディレクトリ構成）
- **言語**: TypeScript（strict 設定）
- **UI**: React 18 + Tailwind CSS、ドラッグ&ドロップは `@dnd-kit/core`
- **API**: `app/api/convert/route.ts` に実装した Node Runtime API。`NextResponse` でバイナリレスポンスを返却
- **画像変換**: `sharp` による WebP 変換（品質 90、`rotate()` で EXIF 補正）
- **ZIP 生成**: クライアント側で `jszip` を動的インポートして生成。サーバー側はフォールバックとして ZIP 返却可能
- **ユーティリティ**: `lib/sanitizeFilename.ts` にファイル名サニタイズ・制約定義。`lib/i18n.ts` にロケール別文言

## 5. 機能要件
### 5.1 アップロード & 並べ替え
- `.jpg`, `.jpeg`, `.png` のみ受け付け、最大 25 件まで保持
- ファイル追加は入力ボタンまたはドラッグ&ドロップで行い、未対応拡張子は即時警告
- `@dnd-kit` を用いたドラッグ操作でサムネイルカードを並べ替え。削除ボタンで個別除外

### 5.2 ベース名指定
- 初期値は `image`。入力値はクライアント・サーバー双方で `sanitizeFilename` により危険文字排除
- 生成ファイル名は `<base>_<index>.webp`（1 始まり、並び順に依存）

### 5.3 変換処理
- クライアントは各ファイルごとに `POST /api/convert` へ `FormData` を送信（`base_name`, `file_index`, `files`）
- API はバリデーション（拡張子、件数）を行い、`sharp` で WebP 変換→バッファをレスポンス
- 単一ファイル: `Content-Type: image/webp` でバイナリ返却
- 複数ファイル: クライアント側で `jszip` により ZIP 化し、`<base>_webp.zip` としてダウンロード
- エラー時は JSON `{ error: "<code>" }` を返し、フロント側でロケールに応じたメッセージを表示

### 5.4 進捗 & メッセージ
- 変換中は進捗バーと `(現在/総数)` を表示し、キャンセルは不可
- 成功時・失敗時のフィードバックをカード下部に表示。3 か国語に対応

### 5.5 多言語対応
- ロケール切替 UI を備え、選択状態を `useState` で保持
- 文言マッピングは `lib/i18n.ts` にて定義。未翻訳キーが増えた場合は全言語分追加する
- 初回ロード時は `navigator.language` から最適なロケールを推定

## 6. 制約・バリデーション
- `MAX_FILES = 25`。超過時は `too_many_files` エラー
- 危険文字（`<>:"/\|?*` など）はファイル名から除去。空文字は `image`
- フロントでは未対応拡張子を追加しない。サーバーでも拡張子を最終チェックし、全件不適合なら `no_valid_files`
- 想定最大リクエストサイズは 100MB（各環境でリバースプロキシ等の制限に留意）

## 7. 非機能要件
- **パフォーマンス**: 変換は同期処理。大量アクセス時は Vercel の Serverless Functions（Node runtime）を水平スケールで処理
- **セキュリティ**: 拡張子チェック・サニタイズ済みファイル名でディレクトリトラバーサルを抑止。アップロードファイルはメモリ上で扱い、永続保存しない
- **安定運用**: エラー発生時もステータスコード 400/500 を返却し、クライアント通知
- **アクセシビリティ**: 主要ボタンはキーボード操作対応。進捗文言はスクリーンリーダーで読めるようテキスト表示

## 8. 運用・デプロイ
- ローカル開発は `npm run dev` で `http://localhost:3000` を起動
- ビルド/デプロイは `npm run build` → `npm run start`。Vercel では `npm run build` が自動実行され、Node ランタイムで API が動作
- canary リリースを利用しているため、依存アップデート時は CI で `npm install` → `npm run lint` → `npm run build` を必ず回す

## 9. 今後の拡張案
- 画像品質・画質調整スライダーの追加（`sharp` オプション expose）
- フロント側でのバリデーション強化（ファイルサイズ合計、同名ファイルへの警告）
- `next-intl` 等を用いたルーティング連動の国際化
- Next.js Server Actions による一括アップロード → サーバー ZIP 生成フローへの移行
