# Webplyzer 要件定義書

## 1. プロダクト概要
Webplyzer は画像ファイル（JPG/JPEG/PNG）を WebP 形式へ一括変換し、連番リネームと一括ダウンロードを提供する Flask ベースの Web アプリケーションです。フロントエンドは Jinja2 テンプレートとプレーン JavaScript で構成され、ドラッグ＆ドロップで並べ替え可能なサムネイル UI を備えています。

## 2. 提供価値
- **最適化の省力化**: まとめて変換・リネームすることでサイト運用時の画像管理コストを削減。
- **運用の安定化**: サーバー側で Pillow を用いて確実に WebP 変換を行い、失敗時は明示的にエラーを返却。
- **多言語対応**: 日本語・英語・韓国語の UI を Flask-Babel で提供し、海外チームとも共同運用しやすい。

## 3. 対象ユーザー
- Web 制作／運用担当者
- ブログ・メディア編集者
- 商品画像を大量に扱う EC 運営者

## 4. システム構成
- **バックエンド**: Python 3 + Flask 3 (`app.py`)。エンドポイント `/` と `/convert` を提供。
- **テンプレート**: `templates/index.html`（Jinja2）で UI を構築し、`static/style.css` でレイアウト・テーマを定義。
- **国際化**: `Flask-Babel` を利用し、`translations/<locale>/LC_MESSAGES/messages.po|.mo` に文言を保持。既定ロケールは日本語。
- **フロントエンドライブラリ**: 並べ替えに `SortableJS`、複数ファイルのクライアントサイド ZIP 生成に `JSZip` を使用。
- **一時ファイル**: 変換結果を `/tmp` に保存。レスポンス完了時に自動削除する。
- **デプロイ**: `vercel.json` により Vercel 上で `app.py` を起動する構成。

## 5. 機能要件
### 5.1 画像アップロード
- 複数ファイルを一括選択できる（最大 25 件）。
- 対応拡張子は `.jpg`, `.jpeg`, `.png`。その他のファイルはフロント・バック両方で弾く。
- 選択済みファイルはサムネイルカードで一覧表示し、削除操作を個別に提供する。

### 5.2 ファイル名指定
- ユーザーは変換後ファイルのベース名を入力できる。初期値は `image`。
- バックエンド側は `sanitize_filename` で危険文字を除去しつつ、多言語文字は保持する。
- 生成されるファイル名は `<base_name>_<index>.webp`（1 始まりの連番）。

### 5.3 並べ替え
- `SortableJS` を用いてドラッグ操作で順序を変更できる。
- 並べ替え結果はクライアント側の配列に反映され、その順序で変換 API を順次呼び出す。

### 5.4 変換 API (`POST /convert`)
- フロントエンドから `FormData` で `base_name`, `file_index`, `files` を送信。
- Pillow で画像を開き、必要な場合は RGB へ変換したうえで WebP 形式（品質 90）で保存。
- リクエストに複数ファイルが含まれる場合はサーバー側で ZIP を生成し返却。フロントエンドは現状 1 ファイルずつ送信し、受領した WebP ファイルを `JSZip` でまとめる。
- 成功時:
  - 単一ファイル: `send_file` で WebP を直接返却。
  - 複数ファイル: `application/zip` で返却（サーバー側のフォールバックとして動作）。
- 失敗時は JSON `{ "error": "<message>" }` とともに 400/500 ステータスを返す。

### 5.5 ダウンロード体験
- フロントエンドは変換済み Blob を即座にダウンロードさせる。
- 複数ファイルの場合は JSZip でまとめ、ファイル名 `<base_name>_webp.zip` を生成。
- UI 上で進捗 (`変換中 (n/m)`) を表示し、完了後はメッセージ領域に成功通知を表示する。

### 5.6 多言語対応
- 言語切り替えリンクで `?lang=ja|en|ko` を付与し、`get_locale` でリクエストに応じたロケールを選定。
- 文言キー例: `title`, `upload_label`, `success_message`, `max_25_files`。
- 翻訳追加時は `pybabel extract`, `pybabel update`, `pybabel compile` の手順を必ず実施する。

## 6. 制約とバリデーション
- `MAX_FILES = 25`。超過した場合は 400 エラーと国際化されたメッセージを返す。
- `MAX_CONTENT_LENGTH = 100MB`（全リクエスト合計）。Flask が超過リクエストを拒否する。
- 許可拡張子: `{'jpg', 'jpeg', 'png'}`。不一致の場合は無視し、エラーメッセージを返却。
- ファイル名は `sanitize_filename` により危険文字を除去（<>:"/\|?* など）。空文字の場合は `image` を利用。

## 7. 非機能要件
- **パフォーマンス**: 変換は同期処理だが、1 リクエスト内の画像をループで処理するため、同時アクセスは Gunicorn 等の WSGI サーバーでスケールさせる想定。
- **可用性**: 変換結果は `/tmp` に保存し、レスポンス完了時にクリーンアップ。失敗時も後処理を実施。
- **セキュリティ**: ファイルサイズ制限、拡張子チェック、ファイル名サニタイズでディレクトリトラバーサルや DoS を抑止。
- **ロギング**: 標準 Flask ログに依存。必要に応じて構造化ログを追加する。

## 8. 運用・デプロイ
- ローカル開発は `python app.py`（`FLASK_DEBUG=1` 推奨）で起動し、`http://localhost:5000` へアクセスする。
- Vercel デプロイ時は `app.py` がエントリーポイントとなり、/tmp の書き込みが許可される環境で動作する。
- 翻訳の更新や依存追加時は `requirements.txt` を更新し、デプロイ先でも同じバージョンが利用されるよう管理する。

## 9. 今後の検討事項
- 変換品質や圧縮率を UI から調整できる機能の導入。
- `/convert` へ複数ファイルをまとめて送信し、サーバー側で ZIP を返すフローヘの移行。
- 変換ジョブの進捗表示を WebSocket などでリアルタイム化する拡張。
